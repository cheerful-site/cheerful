<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.cheerful_back.domain.map.MapInfoMapper">

    <resultMap id="MapInfoMap" type="com.korit.cheerful_back.domain.map.MapInfo">
        <id     property="mapInfoId"            column="map_info_id"/>
        <result property="mapInfoName"          column="map_info_name"/>
        <result property="mapInfoCategoryId"    column="map_info_category_id"/>
        <result property="mapInfoAddress"       column="map_info_address"/>
        <result property="mapInfoOperationTime" column="map_info_operation_time"/>
        <result property="mapInfoPhoneNumber"   column="map_info_phone_number"/>
        <result property="mapInfoLat"           column="map_info_lat"/>
        <result property="mapInfoLng"           column="map_info_lng"/>
        <result property="mapInfoFullTime"      column="map_info_full_time"/>
        <result property="mapInfoContent"       column="map_info_content"/>
    </resultMap>

    <select id="selectNearby" resultMap="MapInfoMap">
        <![CDATA[
      SELECT
        mi.*,
        ST_Distance_Sphere(POINT(mi.map_info_lng, mi.map_info_lat), POINT(#{lng}, #{lat})) AS distance_m
      FROM map_info_tb mi
      WHERE mi.map_info_category_id = #{categoryId}
        AND ST_Distance_Sphere(POINT(mi.map_info_lng, mi.map_info_lat), POINT(#{lng}, #{lat})) <= #{radius}
      ORDER BY distance_m ASC
      LIMIT #{limit}
    ]]>
    </select>

    <select id="existsByNameAndCoords" resultType="int">
        <![CDATA[
      SELECT COUNT(*)
      FROM map_info_tb
      WHERE map_info_name = #{name}
        AND map_info_lat  = #{lat}
        AND map_info_lng  = #{lng}
    ]]>
    </select>

    <!-- INSERT -->
    <insert id="insertOne" useGeneratedKeys="true" keyProperty="mapInfoId" keyColumn="map_info_id">
        <![CDATA[
      INSERT INTO map_info_tb (
        map_info_name, map_info_category_id, map_info_address,
        map_info_operation_time, map_info_phone_number,
        map_info_lat, map_info_lng, map_info_full_time, map_info_content
      ) VALUES (
        #{mapInfoName},
        #{mapInfoCategoryId},
        COALESCE(#{mapInfoAddress}, ''),
        COALESCE(#{mapInfoOperationTime}, ''),
        COALESCE(#{mapInfoPhoneNumber}, ''),
        #{mapInfoLat},
        #{mapInfoLng},
        COALESCE(#{mapInfoFullTime}, 0),
        COALESCE(#{mapInfoContent}, '')
      )
    ]]>
    </insert>

    <!-- UPDATE: null 인자는 컬럼의 기존 값을 유지 -->
    <update id="updateByNaturalKey">
        <![CDATA[
      UPDATE map_info_tb
      SET
        map_info_address        = COALESCE(#{mapInfoAddress},        map_info_address),
        map_info_operation_time = COALESCE(#{mapInfoOperationTime},  map_info_operation_time),
        map_info_phone_number   = COALESCE(#{mapInfoPhoneNumber},    map_info_phone_number),
        map_info_full_time      = COALESCE(#{mapInfoFullTime},       map_info_full_time),
        map_info_content        = COALESCE(#{mapInfoContent},        map_info_content)
      WHERE map_info_name = #{mapInfoName}
        AND map_info_lat  = #{mapInfoLat}
        AND map_info_lng  = #{mapInfoLng}
    ]]>
    </update>
</mapper>